<div class="dynamic-table-container" #tableContainer>
  <!-- Sticky Header -->
  <div class="table-header" [style.height.px]="headerHeight">
    <div class="header-row" #headerRow (scroll)="onHeaderScroll($event)">
      <!-- Left Frozen Columns -->
      <div class="frozen-left" [style.width.px]="getLeftFrozenWidth()" *ngIf="leftFrozenColumns.length > 0"
        role="presentation">
        <div class="header-cell"
          *ngFor="let column of leftFrozenColumns; trackBy: trackByColumnField; let colIndex = index"
          [style.width]="getColumnWidth(column)" [class.sortable]="column.sortable"
          [class.sort-asc]="sortState.field === column.field && sortState.direction === 'asc'"
          [class.sort-desc]="sortState.field === column.field && sortState.direction === 'desc'"
          [attr.role]="'columnheader'" [attr.aria-sort]="getAriaSort(column)" [attr.aria-colindex]="colIndex + 1"
          [attr.aria-label]="column.header + (column.sortable ? ' (click to sort)' : '')" (click)="onSort(column)"
          (keydown.enter)="onSort(column)" (keydown.space)="onSort(column); $event.preventDefault()"
          [tabindex]="column.sortable ? '0' : '-1'" [attr.data-column-id]="column.field">
          <ng-container *ngIf="!headerTemplate; else customHeader">
            <span class="header-text">{{ column.header }}</span>
          </ng-container>
          <ng-template #customHeader>
            <ng-container [ngTemplateOutlet]="headerTemplate" [ngTemplateOutletContext]="{ column: column }">
            </ng-container>

          </ng-template>
          <span class="sort-icon" *ngIf="column.sortable">{{ getSortIcon(column) }}</span>
          <div class="resize-handle" (mousedown)="onResizeStart($event, column)"></div>
        </div>
      </div>

      <!-- Center Scrollable Columns -->
      <div class="center-columns" #headeCenterRow role="presentation" [ngStyle]="{'transform': headerTransform}">
        <div class="header-cell" *ngFor="let column of centerColumns; trackBy: trackByColumnField; let colIndex = index"
          [style.width]="getColumnWidth(column)" [class.sortable]="column.sortable"
          [class.sort-asc]="sortState.field === column.field && sortState.direction === 'asc'"
          [class.sort-desc]="sortState.field === column.field && sortState.direction === 'desc'"
          [attr.role]="'columnheader'" [attr.aria-sort]="getAriaSort(column)"
          [attr.aria-colindex]="leftFrozenColumns.length + colIndex + 1"
          [attr.aria-label]="column.header + (column.sortable ? ' (click to sort)' : '')" (click)="onSort(column)"
          (keydown.enter)="onSort(column)" (keydown.space)="onSort(column); $event.preventDefault()"
          [tabindex]="column.sortable ? '0' : '-1'" [attr.data-column-id]="column.field">
          <ng-container *ngIf="!headerTemplate; else customHeader">
            <span class="header-text">{{ column.header }}</span>
          </ng-container>
          <ng-template #customHeader>
            <ng-container [ngTemplateOutlet]="headerTemplate"
              [ngTemplateOutletContext]="{ column: column }"></ng-container>
          </ng-template>
          <span class="sort-icon" *ngIf="column.sortable">{{ getSortIcon(column) }}</span>
          <div class="resize-handle" (mousedown)="onResizeStart($event, column)"></div>
        </div>
      </div>

      <!-- Right Frozen Columns -->
      <div class="frozen-right" [style.width.px]="getRightFrozenWidth()" *ngIf="rightFrozenColumns.length > 0">
        <div class="header-cell" *ngFor="let column of rightFrozenColumns; trackBy: trackByColumnField"
          [style.width]="getColumnWidth(column)" [class.sortable]="column.sortable" (click)="onSort(column)">
          <ng-container *ngIf="!headerTemplate; else customHeader">
            <span class="header-text">{{ column.header }}</span>
          </ng-container>
          <ng-template #customHeader>
            <ng-container [ngTemplateOutlet]="headerTemplate"
              [ngTemplateOutletContext]="{ column: column }"></ng-container>
          </ng-template>
          <span class="sort-icon" *ngIf="column.sortable">{{ getSortIcon(column) }}</span>
          <div class="resize-handle" (mousedown)="onResizeStart($event, column)"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Table Body with Virtual Scrolling -->
  <div class="table-body" #tableBody [style.height]="'calc(100% - ' + headerHeight + 'px)'"
    (scroll)="onBodyScroll($event)">
    <!-- Virtual spacer for total height -->
    <div class="virtual-spacer" [style.height.px]="totalHeight"></div>

    <!-- Visible rows container -->
    <div class="visible-rows" [style.transform]="'translateY(' + offsetY + 'px)'">
      <div class="table-row" *ngFor="let row of visibleRows; let i = index; trackBy: trackByRowIndex"
        [style.height.px]="rowHeight">

        <!-- Left Frozen Columns -->
        <div class="frozen-left" [style.width.px]="getLeftFrozenWidth()" *ngIf="leftFrozenColumns.length > 0">
          <div class="table-cell" *ngFor="let column of leftFrozenColumns; trackBy: trackByColumnField"
            [style.width]="getColumnWidth(column)">
            <ng-container *ngIf="!cellTemplate; else customCell">
              {{ getCellValue(row, column) }}
            </ng-container>
            <ng-template #customCell>
              <ng-container [ngTemplateOutlet]="cellTemplate"
                [ngTemplateOutletContext]="{ row: row, column: column }"></ng-container>
            </ng-template>
          </div>
        </div>

        <!-- Center Scrollable Columns -->
        <div class="center-columns">
          <div class="table-cell" *ngFor="let column of centerColumns; trackBy: trackByColumnField"
            [style.width]="getColumnWidth(column)">
            <ng-container *ngIf="!cellTemplate; else customCell">
              {{ getCellValue(row, column) }}
            </ng-container>
            <ng-template #customCell>
              <ng-container [ngTemplateOutlet]="cellTemplate"
                [ngTemplateOutletContext]="{ row: row, column: column }"></ng-container>
            </ng-template>
          </div>
        </div>

        <!-- Right Frozen Columns -->
        <div class="frozen-right" [style.width.px]="getRightFrozenWidth()" *ngIf="rightFrozenColumns.length > 0">
          <div class="table-cell" *ngFor="let column of rightFrozenColumns; trackBy: trackByColumnField"
            [style.width]="getColumnWidth(column)">
            <ng-container *ngIf="!cellTemplate; else customCell">
              {{ getCellValue(row, column) }}
            </ng-container>
            <ng-template #customCell>
              <ng-container [ngTemplateOutlet]="cellTemplate"
                [ngTemplateOutletContext]="{ row: row, column: column }"></ng-container>
            </ng-template>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>